<!DOCTYPE html>
<!-- saved from url=(0026)https://mattreagandev.com/ -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="google-site-verification" content="skHd5zUjXdyOTYTg_o18nnePm9rpurTTAenEVVntMBU">
<title>Matt Reagan's Website</title>
<link rel="preconnect" href="https://fonts.googleapis.com/">
<link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
<link href="./SpriteKit Shadre_files/css2" rel="stylesheet">
	<link href="./SpriteKit Shadre_files/css" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="./SpriteKit Shadre_files/styleUpdated.css">	
</head>
<body>
	<div class="topnavbar">
		<div class="topnavbarmatticon">
			<a href="https://mattreagandev.com/index.php"><img src="./SpriteKit Shadre_files/topbar_matt_icon.png"></a>
		</div>
		<div class="topnavbartitle">
			<span class="topnavbartitleword1">MATT</span><span class="topnavbartitleword2">REAGAN</span>
			<div class="topnavbartitletagline">iOS &amp; macOS engineer,<br>designer, game creator
			</div>
		</div>
		<!--
		<div class="socialbar">
			<div class="socialbuttoncontainer">
				<div class="socialbutton socialbuttontwitter">
						<a href="http://twitter.com/hmblebee"><img src="images/twitter_logo.png" width="32" height="32"></a>
				</div>
			</div>
			<div class="socialbuttoncontainer">
				<div class="socialbutton socialbuttongithub">
						<a href="http://github.com/matthewreagan"><img src="images/github_logo.png" width="32" height="32"></a>
				</div>
			</div>
			<div class="socialbuttoncontainer">
				<div class="socialbutton socialbuttonrss">
						<a href="http://sound-of-silence.com/rss.xml"><img src="images/rss_256.png" width="32" height="32"></a>
				</div>
			</div>
			<div class="socialbuttoncontainer">
				<div class="socialbutton socialbuttonemail">
						<a href="http://sound-of-silence.com/?page=contact"><img src="images/email_256.png" width="32" height="32"></a>
				</div>
			</div>
		</div>
		-->
	</div>
	<div class="mainbody">
		<div class="sidebar">
			<div class="sidebarlinkcontainer">
				<div style="position:relative;left:-2px;top:0px;margin:0px;">
					<div class="socialbuttoncontainer">
						<div class="socialbutton socialbuttontwitter">
								<a href="http://twitter.com/hmblebee"><img src="./SpriteKit Shadre_files/twitter_logo.png" width="32" height="32"></a>
						</div>
					</div>
					<div class="socialbuttoncontainer">
						<div class="socialbutton socialbuttongithub">
								<a href="http://github.com/matthewreagan"><img src="./SpriteKit Shadre_files/github_logo.png" width="32" height="32"></a>
						</div>
					</div>
					<div class="socialbuttoncontainer">
						<div class="socialbutton socialbuttonlinkedin">
								<a href="http://linkedin.com/in/mareagan/"><img src="./SpriteKit Shadre_files/linkedin_logo.png" width="32" height="32"></a>
						</div>
					</div>
					<div class="socialbuttoncontainer">
						<div class="socialbutton socialbuttonrss">
								<a href="http://mattreagandev.com/rss.xml"><img src="./SpriteKit Shadre_files/rss_256.png" width="32" height="32"></a>
						</div>
					</div>
					<div class="socialbuttoncontainer">
						<div class="socialbutton socialbuttonemail">
								<a href="http://mattreagandev.com/?page=contact"><img src="./SpriteKit Shadre_files/email_256.png" width="32" height="32"></a>
						</div>
					</div>
				</div>
				<a href="https://mattreagandev.com/?page=about" class="mainlink" style="margin-bottom:8px;">ABOUT ME</a><br>
				<div class="sidebaraboutmetext">I've been building software for the Mac since the 90's and iOS since 2009. Previously I worked at <a href="http://apple.com/">Apple</a> developing <a href="http://www.apple.com/macos/photos/" title="OS X - Photos - Apple">Photos</a> for Mac &amp; iOS, and at <a href="http://twitch.tv/">Twitch</a> on their native iOS client. I also dabble in design and some other fun <a href="https://mattreagandev.com/?page=interests">hobbies</a>.<br><a href="https://mattreagandev.com/?page=about">More...</a></div>
				<!--<div class="sidebaraboutmetext">I've been writing software for the Mac since 1993. Most recently I worked at <a href="http://apple.com">Apple</a> developing the new <a href="http://www.apple.com/osx/photos/" title="OS X - Photos - Apple">Photos</a> apps for Mac and iOS, and then at <a href="http://shopkeep.com">ShopKeep</a> on their point-of-sale iOS apps. I'm currently an iOS / macOS engineer at <a href="http://articulate.com">Articulate</a>. I also dabble in design and some other fun hobbies.<br><a href="?page=about">More...</a></div>-->
				<a href="https://mattreagandev.com/?page=blog&amp;sort=recent&amp;count=1" class="mainlink">RECENT POSTS</a><br>
				<a href="https://mattreagandev.com/?article=20180806" id="sidebararticlelink">SpriteKit: Shaders &amp; Geometry</a><br><a href="https://mattreagandev.com/?article=20170306" id="sidebararticlelink">Audible Xcode Breakpoints</a><br><a href="https://mattreagandev.com/?article=20170205" id="sidebararticlelink">SpriteKit Text Disintegration</a><br><a href="https://mattreagandev.com/?article=20170201" id="sidebararticlelink">Dust: Dev Blog</a><br><a href="https://mattreagandev.com/?article=20161108" id="sidebararticlelink">SceneKit: Deformable Terrain</a><br><a href="https://mattreagandev.com/?article=20161103" id="sidebararticlelink">Xcode: Quick Look Anything</a><br><a href="https://mattreagandev.com/?article=20161101" id="sidebararticlelink">Modal Windows with AFNetworking</a><br><a href="https://mattreagandev.com/?article=20161016" id="sidebararticlelink">Introducing: GIFPop! v0.9</a><br><a href="https://mattreagandev.com/?article=20160404" id="sidebararticlelink">Web Service Speed Tests with curl</a><br><a href="https://mattreagandev.com/?article=20160324" id="sidebararticlelink">Text Messages from Xcode</a><br><a href="https://mattreagandev.com/?article=20160215" id="sidebararticlelink">Xcode UI Testing Tips &amp; Gotchas</a><br><a href="https://mattreagandev.com/?article=20150923" id="sidebararticlelink">NSView control-click quirks</a><br><a href="https://mattreagandev.com/?article=20120806" id="sidebararticlelink">App launchability via LSItemInfoRecord</a><br>				<a href="https://mattreagandev.com/?page=archive" style="font-size:0.9em;">More...</a><br>
				<a href="https://mattreagandev.com/?page=interests" class="mainlink">INTERESTS</a><br>
				<a href="https://mattreagandev.com/?page=gamedev" id="minorlink">Game Dev</a><br>
				<a href="https://mattreagandev.com/?page=design" id="minorlink">Design</a><br>
				<a href="https://mattreagandev.com/?page=music" id="minorlink">Music</a><br>
				<a href="https://mattreagandev.com/?page=tabletop" id="minorlink">Tabletop Gaming</a><br>
				<a href="https://mattreagandev.com/?page=motorcycles" id="minorlink">Motorcycles</a><br>
				<a href="https://mattreagandev.com/?page=zen" id="minorlink">Zen / Mindfulness</a><br>
				<a href="https://mattreagandev.com/?page=archive" class="mainlink">ARCHIVE</a><br>
				<a href="https://mattreagandev.com/?page=contact" class="mainlink">CONTACT</a><br>
			</div>
			<div class="sidebarbottomtext">
				© 2022 by Matt Reagan
			</div>
		</div>
		<div class="article">
			<!--
			<div style="background-color:#fff7ec;border-radius:5px;height:32px;border:2px dashed #f0cea8;font-size:0.9em;font-color:#372b2a;margin-bottom:14px;position:relative;top:-8px;max-width:1000px;display:inline-block;">
				<div style="margin:6px;margin-top:8px;">
				<img src="/tanks/AppIcon_32.png" width="26" height="26" style="float:left;"><strong style="color:#805042;">Latest Update</strong>:&nbsp;Here for <strong>Tank Wars</strong>? Visit the <a href="/tanks">official webpage</a>.
				</div>
			</div>
		-->
			<div class="articletopdatebox" style="padding-bottom:8px;border-bottom:1px solid #efefef;"><div style="float:left;color:#a8a2a2;">Author: Matt Reagan</div><div style="float:right;"><a href="https://mattreagandev.com/?article=20180801">« Previous</a> | <span class="deadlinkspan">Next »</span></div><br style="clear:both;"></div><div class="articleheaderbox">SpriteKit: Shaders &amp; Geometry</div><div class="articlemaintext">
<div style="text-align:left;">
<div style="float:right;margin:30px;text-align:center;margin-top:4px;">
<img src="./SpriteKit Shadre_files/shader_zoom3.gif" width="320px" height"320px"="" style="border-radius:5px;">
<br><span style="font-size:0.8em;color:#777;">SpriteKit shader &amp; geometry demo</span>
</div>
In <a href="http://mattreagandev.com/?article=20180801" title="Matt Reagan&#39;s Website">recent</a> <a href="http://mattreagandev.com/?article=20170205" title="Matt Reagan&#39;s Website">posts</a> several <a href="https://developer.apple.com/documentation/spritekit/" title="SpriteKit | Apple Developer Documentation">SpriteKit</a> visual effects were explored which could be achieved with little more than a grid of textured <span class="codeinline">SKSpriteNodes</span>. This article will discuss two SpriteKit topics which are a bit more advanced: <strong>Shaders</strong> and <strong>Geometry Deformations</strong>.
<br><br>
Endless visual effects (and <a href="https://mattreagandev.com/?page=gamedev#published">entire games</a>) can be made using just basic <a href="https://developer.apple.com/documentation/spritekit/skspritenode">SKSpriteNodes</a> without ever needing shaders or <span class="codeinline">SKWarpable</span>. Leveraging the power of these two tools, however, opens <strong>entirely new doors</strong> for effects that couldn't be achieved in any other way. The article will introduce both <span class="codeinline">SKShader</span> and <span class="codeinline">SKWarpGeometry</span> and provide some examples of how to use them. 
<br><br>
This post will explore how to make the pool simulation shown to the right. This demo employs a number of <strong>combined effects</strong>:
<ol>
<li><span style="font-weight:bold;color:#777;">(Shader)</span> Ripple effect applied using a <a href="https://en.wikipedia.org/wiki/Sine_wave" title="Sine wave - Wikipedia">sine wave</a>
</li><li><span style="font-weight:bold;color:#777;">(Shader)</span> Edges are darkened and faded (color subtraction also <strong>animates</strong> with its own curve)
</li><li><span style="font-weight:bold;color:#777;">(Shader)</span> Water drifts horizontally (texture wrapping)
</li><li><span style="font-weight:bold;color:#777;">(Geometry)</span> Additional movement is created by randomly <strong>warping</strong> the water using <span class="codeinline">SKWarpGeometryGrid</span>, which causes the edges to lap against the pool rim
</li><li><span style="font-weight:bold;color:#777;">(Particle)</span> Sparkles are created using <span class="codeinline">SKEmitterNode</span></li>
<li><span style="font-weight:bold;color:#777;">(SKAction)</span> Leaves are animated falling into the pool
</li></ol>

There is a lot going on here, and not everything will be covered in detail. But fundamentally all of this is achieved with a mix of some very <strong>basic techniques</strong>, and all with easy-to-use <strong>SpriteKit</strong> classes. The most powerful of them by far is <span class="codeinline">SKShader</span>, so let's start there.
<br><br>
<div class="blognotebluesmall"><img src="./SpriteKit Shadre_files/swiftIcon64.png" width="24px" height="24px" style="position:relative;top:5px;">&nbsp;Get the <strong>Swift source code</strong> on GitHub: <a href="https://github.com/matthewreagan/SpriteKitShaders">/matthewreagan/SpriteKitShaders</a></div>
<h3>Video</h3>
<iframe width="768" height="432" src="./SpriteKit Shadre_files/4VO97nosweA.html" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen=""></iframe>
<br>
<h2>SKShader</h2>
<span class="codeinline">SKShader</span> provies an easy way to use <a href="https://www.khronos.org/opengl/wiki/Fragment_Shader" title="Fragment Shader - OpenGL Wiki">fragment shaders</a> with your SpriteKit nodes. These shaders are essentially mini-programs written in a <a href="https://en.wikipedia.org/wiki/C_(programming_language)" title="C (programming language) - Wikipedia">C</a>-like language (<a href="https://www.khronos.org/files/opengles_shading_language.pdf">OpenGL ES 2.0 Shading Language</a>, or 'GLSL') which allows you to calculate the resulting color for each pixel in the rendered sprite.
<br><br>
This provides <strong>tremendous power</strong>, since you can completely control how your sprite is drawn on a pixel-by-pixel basis. Although these shader programs are run for each pixel, they are executed on the <strong>GPU</strong> in a massively <em>parallelized</em> fashion and are thus extremely fast.

<h3>The <span style="font-family:courier,mono;">main()</span> Function</h3>
All shaders should have a <span class="codeinline">main()</span> function. This function can perform any calculations you like, but it must at some point set the value of <span class="codeinline">gl_FragColor</span> (a <strong>vec4</strong>, which is a data structure which can hold our <a href="https://en.wikipedia.org/wiki/RGBA_color_space" title="RGBA color space - Wikipedia">RGBA</a> values). The resulting <span class="codeinline">gl_FragColor</span> will be the color for the specific sprite pixel being computed (fragment shaders don't operate exactly on pixels <em>per se</em>, but it can be useful to think of them in this way).

<h3>GLSL Data Structures</h3>
A deep dive of the OpenGL Shading Language is beyond the scope of this post, but the table below will provide a quick <strong>crash course</strong> on some of the fundamental data structures and functions you'll likely make use of in most basic shaders. Some familiarity with the <a href="https://en.wikipedia.org/wiki/C_(programming_language)" title="C (programming language) - Wikipedia">C programming language</a> will come in handy, since that is the language GLSL's syntax is based on.
<br><br>
<span style="font-size:0.8em;color:#777;">Common GLSL data structures &amp; functions</span>
<table style="font-size:.9em;line-height:2.2em;border:1px solid #eee;padding:10px;">
<tbody><tr><td style="text-align:right;vertical-align:top;font-weight:bold;padding-right:20px;font-family:courier,mono;">int</td><td>Integer value.
</td></tr><tr><td style="text-align:right;vertical-align:top;font-weight:bold;padding-right:20px;font-family:courier,mono;">float</td><td>Floating point value.
</td></tr><tr><td style="text-align:right;vertical-align:top;font-weight:bold;padding-right:20px;font-family:courier,mono;">vec2</td><td>A data structure of 2 floats, frequently used to represent 2D coordinates.
</td></tr><tr><td style="text-align:right;vertical-align:top;font-weight:bold;padding-right:20px;font-family:courier,mono;">vec4</td><td>A data structure of 4 floats. These are typically used to represent <strong>RGBA</strong> colors, where each value is in the range of <em>0.0-1.0</em>.
</td></tr><tr><td style="text-align:right;vertical-align:top;font-weight:bold;padding-right:20px;font-family:courier,mono;">v_tex_coord</td><td>A <strong>vec2</strong> which represents the current fragment / pixel we're calculating for. The x,y values are in normalized texture coordinates (in the range of <em>0.0-1.0</em>, where <strong>0.5, 0.5</strong> is the 'center' of the sprite texture).
</td></tr><tr><td style="text-align:right;vertical-align:top;font-weight:bold;padding-right:20px;font-family:courier,mono;">gl_FragColor</td><td>This <strong>vec4</strong> must be set at some point in the shader. The value of this will be the color which is rendered for the particular fragment.
</td></tr><tr><td style="text-align:right;vertical-align:top;font-weight:bold;padding-right:20px;font-family:courier,mono;">u_texture</td><td>This represents the texture being used to render the current node. We can get the target color of any pixel in the current texture by calling <span class="codeinline">texture2D(u_texture, coord)</span>.
</td></tr><tr><td style="text-align:right;vertical-align:top;font-weight:bold;padding-right:20px;font-family:courier,mono;">u_time</td><td>This provides the current <strong>elapsed time</strong> in the simulation. It is a <a href="https://www.khronos.org/opengl/wiki/Uniform_(GLSL)" title="Uniform (GLSL) - OpenGL Wiki"><em>uniform</em></a> (its value will be consistent among all of the threads running the shader code for this sprite) which can be used to animate or modulate the shader.
</td></tr><tr><td style="text-align:right;vertical-align:top;font-weight:bold;padding-right:20px;font-family:courier,mono;">SKDefaultShading()</td><td>As the prefix implies, this is a <strong>SpriteKit-specific</strong> function which provides the default blended color which would normally be used for this fragment.				
</td></tr></tbody></table>
<br>
<h2>Basic Shader Example</h2>
Let's start by writing a very simple shader which tints our demo pool's water texture green (to create a nice algae bloom). There are just a <strong>few steps</strong> to creating this shader:
<ol>
<li>Create a new empty file with a <strong>.fsh</strong> extension for the shader code
</li><li>Write a <strong>main()</strong> function with no arguments which returns void:
<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="codeinline">void main() { }</span>
</li><li>Get the color which would have been drawn, using <strong>SKDefaultShading()</strong>:
<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="codeinline">vec4 color = SKDefaultShading();</span>
</li><li>Return a custom color with the red and blue channels <strong>zeroed</strong> out, leaving us just green:
<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="codeinline">gl_FragColor = vec4(0.0, color.g * color.a, 0.0, color.a);</span>
</li></ol>
Note that as part of the above calculation we also premultiply the color by the alpha value to ensure our sprite's transparency is preserved (for more info see the <a href="https://developer.apple.com/documentation/spritekit/skshader" title="SKShader - SpriteKit | Apple Developer Documentation">SKShader documentation</a>). And this is what the final '<strong>algae bloom</strong>' shader code looks like:
<br><br>
<div class="codeinline" style="overflow:auto;"><pre style="line-height:1.5em;">void main() {
    vec4 color = SKDefaultShading();
    gl_FragColor = vec4(0.0, color.g * color.a, 0.0, color.a);
}
</pre></div>
<br>
Applying the above shader to the water-textured node in the demo app results in a lovely slime-filled pool:
<br>
<div style="text-align:center;">
<div style="width:280px;height:290px;display:inline-block;"><span style="font-size:0.8em;color:#777;"><em>Water.png</em> before shader</span><br><img src="./SpriteKit Shadre_files/original_water_texture.jpg" width="260px" height="260px"></div>
<div style="width:280px;height:290px;display:inline-block;"><span style="font-size:0.8em;color:#777;">With shader applied</span><br><img src="./SpriteKit Shadre_files/algae_bloom.jpg" width="260px" height="260px"></div>
</div>
<h3>Using Shader Files with Xcode</h3>
<img src="./SpriteKit Shadre_files/xcode256.png" width="140px" height="140px" class="articleimagenoshadowright" style="margin-top:0px;">
Using our new shader in a SpriteKit <strong>Xcode project</strong> for either <strong>iOS</strong> or <strong>macOS</strong> is as simple as putting the code in an <strong>.fsh</strong> file, adding it to the Xcode project (ensuring it is included as a resource for the target app), and then instantiating an <span class="codeinline">SKShader</span> with the file name:
<br><br>
<span class="codeinline">let shader = SKShader(fileNamed: "myShader.fsh")</span>
<br><br>
We can then set the <span class="codeinline">shader</span> property on any <strong>SKSpriteNode</strong> or <strong>SKEffectNode</strong>:
<br><br>
<span class="codeinline">mySprite.shader = shader</span>
<br><br>
Once again, SpriteKit makes things incredibly simple for us. We've just written a custom fragment shader, loaded it, and applied it to a textured sprite node in <em>2 lines of code</em>.

<h2>Liquid Shader Example</h2>
<img src="./SpriteKit Shadre_files/simple_liquid_example_resized.gif" width="260px" height="260px" class="articleimagenoshadowright" style="margin-top:0px;border-radius:5px;">For the next step, we'll look at writing a shader which creates a <strong>ripple effect</strong>. This is far more interesting than our simple colorization shader above, but is nearly as simple.
<br><br>
To create it, we take advantage of the fact that our fragment shader can retrieve color values for <em>neighboring pixels</em> and return them for another coordinate. This can create warping effects where nearby pixels are actually shown for a given <strong>X,Y</strong> rather than the color that would be seen normally if the texture were completely 'flat'.
<br><br>
Creating this ripple effect is as simple as offsetting the current <strong>X,Y</strong> the shader is computing using <span class="codeinline">cos()</span> and <span class="codeinline">sin()</span> functions. We then use the adjusted coordinate to sample the texture and return a nearby color value.
<br><br>
In practice, the code looks like this:
<br>
<div class="codeinline" style="overflow:auto;"><pre style="line-height:1.5em;">vec2 coord = v_tex_coord;
coord.x += cos((coord.x + speed) * frequency) * intensity;
coord.y += sin((coord.y + speed) * frequency) * intensity;
vec4 targetPixelColor = texture2D(u_texture, coord);
gl_FragColor = targetPixelColor;
</pre></div>
<br>
This shader is included in the pool <a href="https://github.com/matthewreagan/SpriteKitShaders">demo project</a> (in the file <strong>simpleLiquidShader.fsh</strong>). It uses a few predefined variables (<em>speed</em>, <em>frequency</em>, and <em>intensity</em>) which can be adjusted if desired to change the overall effect. The speed variable in the above code is based on <span class="codeinline">u_time</span> so that the rippling continues to change as the SpriteKit simulation progresses.
<br>
<h3>OpenGL vs. Metal</h3>
Before going any further, a quick note on <em>OpenGL</em> and <em>Metal</em>. The recent transition to <a href="https://developer.apple.com/documentation/metal" title="Metal | Apple Developer Documentation">Metal</a> by Apple in iOS and macOS means that your shaders may be compiled differently depending on what hardware they are loaded on.
<br><br>
You should always test your shaders for <strong>both</strong> OpenGL and Metal environments. You can do this by adding a <span class="codeinline">PrefersOpenGL</span> boolean key to your target's <strong>Info.plist</strong>. If this boolean is set to <strong>YES</strong>, it will force an OpenGL environment. You may find that certain GLSL syntax is valid in one but not the other, or you may observe rendering differences between the two, so it's important to test your shaders in both.
<br><br>
<div style="text-align:center;">
<img src="./SpriteKit Shadre_files/prefersOpenGLKey.png" width="480px" height="48px">
</div>
<br>
You can also use the <span class="codeinline">debugDrawStats_SKContextType</span> defaults key to display the current renderer in the bottom-right corner of your <strong>SKView</strong>. Example:
<br><br>
<div class="codeinline" style="overflow:auto;"><pre style="line-height:1.5em;">var skDefaultsDictionary = [String: Any]()
skDefaultsDictionary["debugDrawStats_SKContextType"] = true
UserDefaults.standard.set(skDefaultsDictionary, forKey: "SKDefaults")
</pre></div>

<h3>Uniforms &amp; Attributes</h3>
Uniforms and attributes can be leveraged within your shaders to provide additional flexibility in your fragment calculations. These won't be covered in this post, but you can learn more about them from Apple's documentation for <a href="https://developer.apple.com/documentation/spritekit/skuniform" title="SKUniform - SpriteKit | Apple Developer Documentation">SKUniform</a> and <a href="https://developer.apple.com/documentation/spritekit/skattribute" title="SKAttribute - SpriteKit | Apple Developer Documentation">SKAttribute</a>. Be sure to also check out the '<strong>Further Reading</strong>' section of links at the bottom.

<h2>Shaders: Putting Things Together</h2>
In the above examples we've seen how we can <strong>colorize</strong> or <strong>deform</strong> a sprite's appearance using simple calculations in our custom fragment shaders. The shader used for the pool simulation combines a number of different adjustments all together, but even though it's doing more calculating, the basic operations are no different than what has been shown so far.
<br><br>
The <span style="font-family:courier,mono;">poolWaterShader.fsh</span> in the demo app does the following:
<br>
<ol>
<li>Applies a <strong>ripple effect</strong> like the shader above
</li><li>Further adjusts the X offset to create a <strong>scrolling / wrapping</strong> effect, for drift
</li><li>Calculates the <strong>distance</strong> for the current pixel from the center of our texture <em>(0.5, 0.5)</em>
</li><li>If distance is <em>&gt; 0.5</em>, immediately returns a clear color (this effectively alpha-masks our texture to be a perfect circle contained inside our previously square-shaped sprite)
</li><li>If within a given threshold, <strong>darkens</strong> and <strong>fades</strong> the edges of the water texture, again using <span class="codeinline">cos()</span> / <span class="codeinline">sin()</span>
</li></ol>
To see a <strong>step-by-step</strong> breakdown you can check the comments in the <span style="font-family:courier,mono;">poolWaterShader.fsh</span>. But aside from a little more math for the extra adjustments, the shader is fairly basic. Here is what the shader looks like once it's applied:
<br>
<div style="text-align:center;">
<div style="width:360px;height:330px;display:inline-block;"><span style="font-size:0.8em;color:#777;"><strong>poolWaterShader.fsh</strong> applied to a checkerboard</span><br><img src="./SpriteKit Shadre_files/final_shader_checker.gif" width="300px" height="300px"></div>
<div style="width:360px;height:330px;display:inline-block;"><span style="font-size:0.8em;color:#777;">...and applied to the demo's <em>water.png</em> texture</span><br><img src="./SpriteKit Shadre_files/final_shader.gif" width="300px" height="300px"></div>
</div>
<br>
<h2>Geometry</h2>
So far using custom shaders has added some nice effects to our pool simulation. But for fun, let's take it a step further. This section will discuss using <span class="codeinline">SKWarpGeometryGrid</span> to further <strong>deform</strong> the water node. This will add additional movement, and will result in the edges of the water appearing to lap against the pool rim.

<h3>SKWarpable &amp; SKWarpGeometry</h3>
<span class="codeinline">SKWarpable</span> is the protocol which nodes can conform to if they support custom geometry. Currently <span class="codeinline">SKSpriteNode</span> and <span class="codeinline">SKEffectNode</span> both support <strong>SKWarpable</strong>. For practical purposes you can warp just about any node, since you can add e.g. an <span class="codeinline">SKLabelNode</span> as a child of an effect node and apply your custom warping geometry to the parent.
<br><br>
SKWarpGeometry is a base superclass from which concrete subclasses like <span class="codeinline">SKWarpGeometryGrid</span> inherit. Our pool simulation uses <strong>SKWarpGeometryGrid</strong> to create the deformation of the water.

<h3>SKWarpGeometry Basics</h3>
<div style="float:right;margin:30px;margin-top:0px;">
<span style="font-size:0.8em;color:#777;">Image from Apple's <a href="https://developer.apple.com/documentation/spritekit/skwarpgeometrygrid" title="SKWarpGeometryGrid - SpriteKit | Apple Developer Documentation">SKWarpGeometryGrid docs</a></span><br>
<img src="./SpriteKit Shadre_files/appleGridWarp.jpg" width="300px" height"171px"=""></div>
The basic premise of deformation with custom geometry is to define a <strong>series of points</strong> on a given node which are then <strong>shifted</strong> to new arbitrary positions. SpriteKit can interpolate between the source and destination points with <span class="codeinline">SKAction.warp(to:,duration:)</span>, and warp the node's appearance to fit the new shape, allowing animations to create the appearance of the node morphing between the two positions.
<br><br>
<span class="codeinline">SKWarpGeometryGrid</span> makes this particularly easy by defining a <strong>grid of points</strong> for the deformation. The point values are normalized, similar to our shader texture coordinates, falling in the range of <em>0.0-1.0</em>. When creating arrays of points (of type <strong>float2</strong>) to use with SKWarpGeometryGrid, the first point in the array will correspond to the bottom-left of the sprite. For the pool demo, the warping does the following:
<ol>
<li>Creates the non-deformed starting source points with a generic grid
</li><li>Periodically creates a new geometry grid, <strong>randomizes</strong> the interior points slightly, and <strong>animates</strong> the water node to fit it
</li></ol>
For example code check out <span class="codeinline">geometryGridPositions(byWarping:)</span> and <span class="codeinline">randomizeWaterGeometry()</span> in <span style="font-family:courier,mono;">PoolScene.swift</span>. In its simplest form, an entire geometry deformation animation can be accomplished with just a few lines of code. Here is an <strong>example</strong>:
<br><br>
<div class="codeinline" style="overflow:auto;"><pre style="line-height:1.5em;">let sourcePoints: [float2] = [float2(0.0, 0.0), float2(1.0, 0.0),
                              float2(0.0, 1.0), float2(1.0, 1.0)]
let destinationPoints: [float2] = [float2(0.0, 0.0), float2(1.0, 0.0),
                                   float2(0.4, 1.0), float2(0.6, 1.0)]
let defaultGeometry = SKWarpGeometryGrid(columns: 1, rows: 1)
myNode.warpGeometry = defaultGeometry
let newGeometry = SKWarpGeometryGrid(columns: 1, rows: 1,
                                     sourcePositions: sourcePoints,
                                     destinationPositions: destinationPoints)
myNode.run(SKAction.warp(to: newGeometry, duration: 1.0)!)
</pre></div>

<h3>Randomized Geometry</h3>
The example code above is fairly basic, defining the 4 corner points needed for a grid consisting of only a single row and column. In our pool simulation we programmatically create the grid points based on our desired resolution (in this case it uses a hardcoded column / row size of 12, which means 13 x 13 = <strong>169</strong> points are ultimately created for the grid).
<br><br>
Each time we run a new geometry animation, we recreate this array of points, but we <strong>slightly offset</strong> the interior points with a randomized value. When this randomized warping is applied to a checkerboard texture we get the image below. When it's applied to our water, we get some additional movement which adds a nice effect. Notice also that the new addition of the geometry deformation creates the appearance of the water edges moving against the pool rim.
<br>
<div style="text-align:center;">
<div style="width:360px;height:330px;display:inline-block;"><span style="font-size:0.8em;color:#777;">Our geometry deformation applied to a checkerboard</span><br><img src="./SpriteKit Shadre_files/geo_checker.gif" width="300px" height="300px"></div>
<div style="width:360px;height:330px;display:inline-block;"><span style="font-size:0.8em;color:#777;">Close-up of warping water edges</span><br><img src="./SpriteKit Shadre_files/geo_water_edges.gif" width="247px" height="300px"></div>
</div>

<h3>More Fun with Particles &amp; <span style="font-family:courier,mono;">SKAction</span></h3>
Some extra effects were added to the pool demo for fun: an <span class="codeinline">SKEmitterNode</span> is used to simulate randomized 'light sparkles' on the surface of the water. The leaves which fall when the user clicks the pool are animated with a series of <span class="codeinline">SKActions</span>. There's nothing particularly special about these actions aside from how multiple groups and sequences are chained to create a more complex effect.
<br><br>
To see exactly how these animations are created check out the <span class="codeinline">dropLeaf(at:)</span> and <span class="codeinline">createRipple(at:)</span> functions in PoolScene.swift. For more information on <strong>SKEmitterNode</strong> check out <a href="https://developer.apple.com/documentation/spritekit/skemitternode" title="SKEmitterNode - SpriteKit | Apple Developer Documentation">Apple's documentation</a> on the class.

<h2>Summing Up</h2>
<strong>Fragment shaders</strong> can be easily leveraged in SpriteKit for both <strong>iOS</strong> and <strong>macOS</strong> using <span class="codeinline">SKShader</span>, and provide powerful control over how your sprite nodes are rendered. The <a href="https://www.khronos.org/files/opengles_shading_language.pdf">OpenGL Shading Language</a> is powerful and flexible, and additional links for reading can be found below. <span class="codeinline">SKWarpable</span> and the related classes like <span class="codeinline">SKWarpGeometryGrid</span> provide the ability to create an endless variety of deformations, and can be easily animated with <span class="codeinline">SKAction.warp(to:, duration:)</span>.
<br><br>
If you have any questions or if you're currently building something with SpriteKit, as usual, please feel free to <a href="https://mattreagandev.com/?page=contact">get in touch</a>. I'd love to see what you're making! Thanks for stopping by.

<h3>Further Reading</h3>
SKShader Docs: <a href="https://developer.apple.com/documentation/spritekit/skshader" title="SKShader - SpriteKit | Apple Developer Documentation">https://developer.apple.com/documentation/spritekit/skshader</a><br>
SKWarpable: <a href="https://developer.apple.com/documentation/spritekit/skwarpable" title="SKWarpable - SpriteKit | Apple Developer Documentation">https://developer.apple.com/documentation/spritekit/skwarpable</a><br>
GLSL Overview: <a href="https://www.khronos.org/opengl/wiki/Core_Language_(GLSL)" title="Core Language (GLSL) - OpenGL Wiki">https://www.khronos.org/opengl/wiki/Core_Language_(GLSL)</a><br>
OpenGL ES Homepage: <a href="https://www.khronos.org/opengles/" title="OpenGL ES Overview
 - The Khronos Group Inc">https://www.khronos.org/opengles/</a><br>
OpenGL ES 2.0 Reference: <a href="https://www.khronos.org/registry/OpenGL-Refpages/es2.0/" title="OpenGL ES 2.0 Reference Pages">https://www.khronos.org/registry/OpenGL-Refpages/es2.0/</a><br>
The Book of Shaders: <a href="https://thebookofshaders.com/01/" title="The Book of Shaders: What is a shader?">https://thebookofshaders.com/01/</a>
<br><br>

</div></div><div class="articletopdatebox"><div style="float:left;"><a href="https://mattreagandev.com/?page=archive">View All Blog Entries</a> | <a href="https://mattreagandev.com/rss.xml">RSS Feed</a></div><div style="float:right;"><a href="https://mattreagandev.com/?article=20180801">« Previous</a> | <span class="deadlinkspan">Next »</span><br><br></div><br style="clear:both;"></div>		</div>	
	</div>

</body></html>